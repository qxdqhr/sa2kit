# ✨ 列表循环功能添加说明

## 功能概述

在播放列表的工具区添加了**列表循环开关**，位于单节点循环按钮的左侧。

## 功能特性

### 两种循环模式

1. **列表循环** (绿色图标)
   - 图标：`Repeat`（循环箭头）
   - 颜色：绿色高亮（`bg-green-500/30`）
   - 功能：播放到最后一个节点后，自动跳回第一个节点继续播放
   - 提示：显示 "列表循环：开启/关闭"

2. **单曲循环** (蓝色图标)
   - 图标：`Repeat1`（带 "1" 的循环箭头）
   - 颜色：蓝色高亮（`bg-blue-500/30`）
   - 功能：当前节点播放结束后，重新播放当前节点
   - 提示：显示 "单曲循环：开启/关闭"

### 优先级规则

- **单曲循环 > 列表循环**
- 如果单曲循环开启，则一直循环当前节点
- 如果单曲循环关闭，列表循环开启，则顺序播放所有节点并循环

## 修改的文件

### 1. `ControlPanel.tsx`

**新增属性**：
```typescript
interface ControlPanelProps {
  // ... 原有属性
  isListLooping?: boolean; // 是否列表循环（播放列表专用）
  onToggleListLoop?: () => void; // 切换列表循环
}
```

**UI 更新**：
```tsx
{/* 列表循环切换（仅播放列表模式） */}
{onToggleListLoop && (
  <button 
    onClick={onToggleListLoop}
    className={`... ${isListLooping ? 'bg-green-500/30' : 'hover:bg-white/20'}`}
    title={isListLooping ? '列表循环：开启' : '列表循环：关闭'}
  >
    <Repeat size={20} />
  </button>
)}

{/* 单节点循环切换 */}
<button 
  onClick={onToggleLoop}
  className={`... ${isLooping ? 'bg-blue-500/30' : 'hover:bg-white/20'}`}
  title={isLooping ? '单曲循环：开启' : '单曲循环：关闭'}
>
  <Repeat1 size={20} />
</button>
```

### 2. `MMDPlaylist.tsx`

**新增状态**：
```typescript
const [isListLooping, setIsListLooping] = useState(loop); // 列表循环
```

**逻辑更新**：
```typescript
// 上一个节点 - 使用 isListLooping 而不是 props.loop
const handlePrevious = useCallback(() => {
  // ...
  } else if (isListLooping) {
    goToNode(nodes.length - 1); // 循环到最后一个
  }
}, [currentIndex, isListLooping, nodes.length, goToNode]);

// 下一个节点
const handleNext = useCallback(() => {
  // ...
  } else if (isListLooping) {
    goToNode(0); // 循环到第一个
  } else {
    onPlaylistComplete?.(); // 播放完成
  }
}, [currentIndex, isListLooping, nodes.length, goToNode, onPlaylistComplete]);
```

**传递给 ControlPanel**：
```tsx
<ControlPanel
  // ...
  isListLooping={isListLooping}
  onToggleListLoop={() => setIsListLooping(!isListLooping)}
/>
```

## 使用场景

### 场景 1：正常播放（两个循环都关闭）
```
播放顺序：1 → 2 → 3 → [结束]
```

### 场景 2：列表循环开启
```
播放顺序：1 → 2 → 3 → 1 → 2 → 3 → ...
```

### 场景 3：单曲循环开启
```
播放顺序：1 → 1 → 1 → ...（只循环当前节点）
```

### 场景 4：两个循环都开启（单曲优先）
```
播放顺序：1 → 1 → 1 → ...（只循环当前节点，忽略列表循环）
```

## 视觉区分

| 功能 | 图标 | 高亮颜色 | 位置 |
|------|------|----------|------|
| 列表循环 | `Repeat` | 绿色 | 左侧 |
| 单曲循环 | `Repeat1` | 蓝色 | 右侧 |

**布局顺序**（从左到右）：
```
[上一首] [播放/暂停] [下一首] ... [列表循环🔄] [单曲循环🔁] [坐标轴] [设置] [全屏]
```

## 默认行为

- **列表循环**：默认继承 `playlist.loop` 属性
- **单曲循环**：默认关闭

```typescript
// 在 MMDPlaylist 中
const [isListLooping, setIsListLooping] = useState(loop); // 从 props 初始化
const [isLooping, setIsLooping] = useState(false); // 默认关闭
```

## 调试信息

在调试面板中可以看到两种循环状态：

```
列表循环: ✅ 开启 / ❌ 关闭
节点循环: ✅ 开启 / ❌ 关闭
```

## 兼容性

- ✅ 与现有的单播放器完全兼容
- ✅ 只在播放列表模式下显示列表循环按钮
- ✅ 单播放器模式仍然只显示单曲循环按钮

## 测试建议

1. **列表循环测试**
   - 创建 3 个节点的播放列表
   - 开启列表循环
   - 播放到第 3 个节点后，检查是否自动跳回第 1 个

2. **单曲循环测试**
   - 开启单曲循环
   - 检查当前节点是否重复播放

3. **两者同时开启**
   - 开启列表循环和单曲循环
   - 确认单曲循环优先（只循环当前节点）

4. **两者都关闭**
   - 播放到最后一个节点
   - 确认播放停止，触发 `onPlaylistComplete`

## 图标说明

使用 `lucide-react` 图标库：
- `Repeat`：标准循环图标（两个循环箭头）
- `Repeat1`：单曲循环图标（带 "1" 的循环箭头）

如果 `Repeat1` 图标不可用，可以降级方案：
```tsx
// 方案 1：使用 Repeat + 数字
<div className="relative">
  <Repeat size={20} />
  <span className="absolute top-0 right-0 text-xs">1</span>
</div>

// 方案 2：自定义 SVG
<svg>...</svg>
```

## 提交信息

```
✨ 添加列表循环功能开关

- 在控制面板添加列表循环按钮（绿色）
- 单曲循环按钮改用 Repeat1 图标（蓝色）
- 列表循环按钮位于单曲循环左侧
- 支持独立控制列表循环和单曲循环
- 单曲循环优先于列表循环
```

---

**功能已完成！** ✅
