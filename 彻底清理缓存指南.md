# 🚨 彻底解决方案 - 清理所有缓存

## 当前问题

你的日志显示：
- ❌ 计数已经到 #19（比之前#15更多）
- ❌ 还是没有清理日志
- ❌ 说明代码还在累积泄漏

**这是因为浏览器还在使用旧代码！**

## 彻底清理步骤

### 1. 停止所有服务
```bash
# 按 Ctrl+C 停止开发服务器
# 或者找到进程杀死
pkill -f "node"
pkill -f "next"
```

### 2. 清除所有构建缓存
```bash
cd /Users/qihongrui/Desktop/sa2kit

# 清除所有可能的缓存
rm -rf dist/
rm -rf .next/
rm -rf node_modules/.cache/
rm -rf .turbo/
rm -rf out/

echo "✅ 所有缓存已清除"
```

### 3. 重新安装依赖（可选但推荐）
```bash
# 如果问题持续，执行这步
rm -rf node_modules/
npm install
```

### 4. 重启开发服务器
```bash
npm run dev
```

### 5. 彻底清除浏览器缓存

**方法1：使用隐身/无痕模式**
- Mac: `Cmd + Shift + N` (Chrome)
- Windows: `Ctrl + Shift + N`
- 在隐身窗口中打开应用

**方法2：清除浏览器缓存**
1. 打开开发者工具 (`Cmd+Option+I` 或 `F12`)
2. 在开发者工具中：
   - 右键点击浏览器刷新按钮
   - 选择 "清空缓存并硬性重新加载"

**方法3：开发者工具设置**
1. 打开开发者工具
2. 进入 Network 标签
3. 勾选 "Disable cache"
4. 保持开发者工具打开状态
5. 刷新页面

### 6. 验证新代码已加载

刷新后，**必须**看到这些日志：

```
[MMDPlayerBase] 🕐 系统启动时间: ...
[MMDPlayerBase] 🧹 Checking for previous physics components...  ← 这是关键！
[MMDPlayerBase] ℹ️ 没有需要清理的物理组件
[MMDPlayerBase] 🎯 Setting up physics component tracking (FIRST TIME)...
[MMDPlayerBase] ✅ Physics component tracking setup complete
```

**如果没有看到 "🧹 Checking for previous"**：
- 说明还是旧代码 ❌
- 继续下一步

### 7. 最后的手段：检查源代码

在浏览器开发者工具中：
1. 打开 Sources 标签
2. 搜索文件：`MMDPlayerBase` 或 `index.mjs`
3. 搜索代码：`Checking for previous`
4. 如果找不到这段代码 → 确认是旧代码
5. 如果找到了 → 但没执行 → 说明代码路径有问题

### 8. 临时解决方案：使用不同端口

如果上述都不行：

```bash
# 停止当前服务
pkill -f node

# 使用不同端口启动
PORT=3002 npm run dev

# 然后访问 http://localhost:3002
```

## 如何确认新代码生效？

### 成功标志：

**首次加载**：
```
✅ [MMDPlayerBase] 🧹 Checking for previous physics components...
✅ [MMDPlayerBase] ℹ️ 没有需要清理的物理组件
✅ [MMDPlayerBase] 🎯 Setting up (FIRST TIME)...
✅ [MMDPlayerBase] 🔍 Captured #1, #2, ... #19
```

**切换模型（第2次）**：
```
✅ [MMDPlayerBase] 🔄 模型切换 #2
✅ [MMDPlayerBase] 🧹 Checking for previous physics components...
✅ [MMDPlayerBase] ⚠️ 检测到未清理的物理组件，立即清理...
✅ [MMDPlayerBase] 📊 未清理组件数量: { total: 95 }  ← 19×5=95
✅ [MMDPlayerBase]   ✅ Destroyed world #19
✅ [MMDPlayerBase]   ✅ Destroyed world #18
...
✅ [MMDPlayerBase] ✅ 已清理 95 个物理组件
✅ [MMDPlayerBase] ℹ️ Monkey Patch already setup, skipping
✅ [MMDPlayerBase] 🔍 Captured #1  ← 重新从1开始！
```

### 失败标志：

```
❌ 直接就是 [MMDPlayerBase] 🔍 Captured #20, #21, #22...
❌ 没有 "🧹 Checking for previous"
❌ 没有清理日志
❌ 计数持续增长
```

## 调试方法

如果新代码还是不生效，在浏览器控制台执行：

```javascript
// 检查 Monkey Patch 标记
console.log('SA2Kit Patch:', window.Ammo?.__sa2kitMonkeyPatched);

// 如果输出 true → 新代码已加载
// 如果输出 undefined → 还是旧代码
```

## 为什么会这样？

浏览器的缓存非常顽固，特别是：
1. Service Worker 缓存
2. HTTP 缓存
3. 浏览器内存缓存
4. 开发服务器的 HMR 缓存

所以需要：
- 清除服务器缓存 ✅
- 停止所有进程 ✅
- 重启服务器 ✅
- 清除浏览器缓存 ✅
- 使用隐身模式 ✅（最可靠）

## 快速测试命令

一键执行所有清理：

```bash
cd /Users/qihongrui/Desktop/sa2kit
pkill -f node
rm -rf dist/ .next/ node_modules/.cache/ .turbo/
npm run dev
```

然后在**隐身窗口**打开应用。

## 总结

**必须看到的3个关键日志**：
1. 🧹 Checking for previous physics components
2. 🎯 Setting up (FIRST TIME)
3. ⚠️ 检测到未清理的物理组件（第2次切换时）

如果看不到，继续清理缓存直到看到为止！

