# 🐛 统计信息修复说明

## 问题描述

用户报告OOM弹窗中的统计信息不正确：
- **问题1**：只加载1次模型，却显示「模型切换次数: 2」
- **问题2**：运行时间显示「0秒」（实际已运行1秒）

![错误的统计信息](assets/image-2218ad74-263b-4a90-8e0b-c3cc622d58b6.png)

## 根本原因分析

### 原因 1：React 严格模式的双重渲染

在开发模式下，React 会**刻意执行两次** `useEffect`：

```
组件挂载
  ↓
useEffect 第1次执行
  ↓ count = 0
  ↓ → count = 1 (系统启动)
  ↓
useEffect cleanup
  ↓
useEffect 第2次执行  ← React 严格模式
  ↓ count = 1
  ↓ → count = 2 (模型切换 #2) ✗
```

**问题**：
- 用户看到的是第2次执行的结果
- 显示「模型切换 #2」，但实际只加载了1次

### 原因 2：启动时间初始化时机错误

**修改前的代码**：
```typescript
const startTimeRef = useRef<number>(Date.now()); // ✗ 组件创建时

const init = async () => {
  if (modelSwitchCountRef.current === 0) {
    // 这里才是真正的首次加载
  }
}
```

**问题**：
- `startTimeRef` 在组件**创建时**初始化
- 不是在**首次加载模型**时初始化
- React 严格模式会创建→销毁→重新创建组件
- 导致 `startTimeRef` 时间不准确

## 解决方案

### 修复 1：延迟初始化启动时间

**修改前**：
```typescript
const startTimeRef = useRef<number>(Date.now());
```

**修改后**：
```typescript
const startTimeRef = useRef<number | null>(null);

// 在 init() 中
if (startTimeRef.current === null) {
  startTimeRef.current = Date.now(); // 首次加载时才记录
  console.log('[MMDPlayerBase] 🕐 系统启动时间:', new Date(startTimeRef.current).toLocaleString());
}
```

**优点**：
- ✅ 只在**真正首次加载**时记录时间
- ✅ 不受 React 严格模式影响
- ✅ 运行时间计算准确

### 修复 2：简化计数逻辑

**修改前**：
```typescript
if (modelSwitchCountRef.current === 0) {
  // 首次加载
  modelSwitchCountRef.current = 1;
  console.log('🕐 系统启动时间:', ...);
} else {
  // 后续切换
  modelSwitchCountRef.current++;
  console.log(`🔄 模型切换 #${count}`, ...);
}
```

**修改后**：
```typescript
// 记录启动时间（只在第一次）
if (startTimeRef.current === null) {
  startTimeRef.current = Date.now();
  console.log('[MMDPlayerBase] 🕐 系统启动时间:', ...);
}

// 累加模型加载次数（每次都执行）
modelSwitchCountRef.current++;
const runningTime = Date.now() - startTimeRef.current;
const minutes = Math.floor(runningTime / 60000);
const seconds = Math.floor((runningTime % 60000) / 1000);
console.log(`[MMDPlayerBase] 🔄 模型加载 #${count} (运行时间: ${minutes}分${seconds}秒)`);
```

**优点**：
- ✅ 逻辑更简单
- ✅ 启动和计数分离
- ✅ 每次都显示运行时间

### 修复 3：用词调整

- **修改前**：「模型切换次数」
- **修改后**：「模型加载次数」

**原因**：
- 首次加载也应该计数
- "切换"暗示至少需要2次操作
- "加载"更准确描述实际行为

## 修改后的行为

### 首次加载
```
[MMDPlayerBase] 🕐 系统启动时间: 2025/12/7 18:30:00
[MMDPlayerBase] 🔄 模型加载 #1 (运行时间: 0分0秒)
```

### 第2次加载（3分钟后切换模型）
```
[MMDPlayerBase] 🔄 模型加载 #2 (运行时间: 3分0秒)
```

### OOM 弹窗显示
```
⚠️ 内存溢出错误 (OOM)

📊 系统运行统计：
• 运行时间: 3分0秒        ← 准确！
• 模型加载次数: 2          ← 准确！
• 启动时间: 2025/12/7 18:30:00
• 错误时间: 2025/12/7 18:33:00

❌ 问题：物理引擎内存不足！
...
```

## 技术细节

### React 严格模式
在开发模式下，React 会刻意执行两次渲染和 effect：
- **目的**：帮助发现副作用问题
- **行为**：Mount → Unmount → Remount
- **影响**：`useEffect` 会执行两次

**正确处理方式**：
- 使用 `null` 作为初始值
- 在 effect 内部检查并初始化
- 确保 cleanup 函数正确

### 为什么不用 useState？
```typescript
// 为什么不用？
const [startTime, setStartTime] = useState(Date.now());

// 原因：
// 1. 改变 state 会触发重新渲染（不需要）
// 2. Date.now() 在每次渲染时都会执行（浪费）
// 3. useRef 更适合存储不触发渲染的值
```

### 时间计算的健壮性
```typescript
// 修改前
const runningTime = Date.now() - startTimeRef.current; // 如果 null 会 NaN

// 修改后  
const runningTime = Date.now() - (startTimeRef.current ?? Date.now()); // 安全
```

## 测试验证

### 测试步骤
1. 重启开发服务器：`npm run dev`
2. 刷新浏览器（强制刷新：`Cmd+Shift+R`）
3. 首次加载，查看控制台
4. 等待 1-2 分钟，切换模型
5. 查看显示的运行时间和加载次数

### 预期结果
- ✅ 首次加载显示「模型加载 #1」
- ✅ 运行时间从 0 秒开始累计
- ✅ 切换模型时计数正确递增
- ✅ OOM 弹窗（如果发生）显示准确的统计信息

## 提交记录
```
commit b9861a3
🐛 修复统计信息 - 正确计算运行时间和模型加载次数
- 延迟初始化启动时间（只在首次加载时）
- 简化计数逻辑（每次都累加）
- 调整用词："模型切换次数" → "模型加载次数"
```

## 相关文件
- `/src/mmd/components/MMDPlayerBase.tsx` - 主要修改

---

**现在统计信息准确了！** ✅

